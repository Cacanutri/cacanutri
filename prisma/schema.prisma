datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  ADMIN
  STAFF
  CLIENT
}

enum OrgRole {
  OWNER
  MEMBER
}

enum PlanCode {
  BASIC
  PRO
  PREMIUM
}

enum ProjectCategory {
  RESTAURANTE
  OFICINA
  LOJA
  SERVICOS
  OUTROS
}

enum ProjectStatus {
  ONBOARDING
  EM_PRODUCAO
  EM_REVISAO
  PUBLICADO
  MANUTENCAO
}

enum TaskStatus {
  TODO
  DOING
  DONE
}

enum TicketStatus {
  ABERTO
  EM_ANDAMENTO
  AGUARDANDO_CLIENTE
  RESOLVIDO
  FECHADO
}

enum TicketPriority {
  BAIXA
  MEDIA
  ALTA
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
}

model User {
  id              String         @id @default(cuid())
  name            String
  email           String         @unique
  passwordHash    String
  role            UserRole       @default(CLIENT)
  termsAcceptedAt DateTime?
  organizations   Organization[] @relation("OrgOwner")
  memberships     Membership[]
  tasksAssigned   Task[]         @relation("TaskAssignee")
  ticketsCreated  Ticket[]       @relation("TicketCreator")
  ticketMessages  TicketMessage[] @relation("TicketAuthor")
  auditLogs       AuditLog[]
  createdAt       DateTime       @default(now())
}

model Organization {
  id          String        @id @default(cuid())
  name        String
  ownerId     String
  owner       User          @relation("OrgOwner", fields: [ownerId], references: [id])
  memberships Membership[]
  projects    Project[]
  invoices    Invoice[]
  createdAt   DateTime      @default(now())
}

model Membership {
  userId         String
  organizationId String
  roleInOrg      OrgRole     @default(MEMBER)
  user           User        @relation(fields: [userId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  @@id([userId, organizationId])
}

model Plan {
  id         String   @id @default(cuid())
  code       PlanCode @unique
  name       String
  priceCents Int
  slaHours   Int
  projects   Project[]
}

model Project {
  id             String          @id @default(cuid())
  organizationId String
  category       ProjectCategory
  planId         String
  status         ProjectStatus   @default(ONBOARDING)
  title          String
  address        String?
  phone          String?
  instagram      String?
  description    String?
  previewUrl     String?
  prodUrl        String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  organization   Organization    @relation(fields: [organizationId], references: [id])
  plan           Plan            @relation(fields: [planId], references: [id])
  intake         Intake?
  assets         Asset[]
  tasks          Task[]
  tickets        Ticket[]
}

model Intake {
  id          String   @id @default(cuid())
  projectId   String   @unique
  dataJson    Json
  submittedAt DateTime?
  isDraft     Boolean  @default(true)
  project     Project  @relation(fields: [projectId], references: [id])
}

model Asset {
  id        String   @id @default(cuid())
  projectId String
  type      String
  filename  String
  path      String
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id])
}

model Task {
  id         String     @id @default(cuid())
  projectId  String
  title      String
  status     TaskStatus @default(TODO)
  assigneeId String?
  createdAt  DateTime   @default(now())
  project    Project    @relation(fields: [projectId], references: [id])
  assignee   User?      @relation("TaskAssignee", fields: [assigneeId], references: [id])
}

model Ticket {
  id            String         @id @default(cuid())
  projectId     String
  createdById   String
  status        TicketStatus   @default(ABERTO)
  priority      TicketPriority @default(MEDIA)
  subject       String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  project       Project        @relation(fields: [projectId], references: [id])
  createdBy     User           @relation("TicketCreator", fields: [createdById], references: [id])
  messages      TicketMessage[]
}

model TicketMessage {
  id        String   @id @default(cuid())
  ticketId  String
  authorId  String
  message   String
  createdAt DateTime @default(now())
  ticket    Ticket   @relation(fields: [ticketId], references: [id])
  author    User     @relation("TicketAuthor", fields: [authorId], references: [id])
}

model Invoice {
  id             String        @id @default(cuid())
  organizationId String
  amountCents    Int
  status         InvoiceStatus @default(PENDING)
  provider       String
  reference      String
  createdAt      DateTime      @default(now())
  organization   Organization  @relation(fields: [organizationId], references: [id])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  metaJson   Json?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])
}
