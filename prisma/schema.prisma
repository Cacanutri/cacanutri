generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  ADMIN
  STAFF
  CLIENT
}

enum ProjectStatus {
  ONBOARDING
  EM_PRODUCAO
  EM_REVISAO
  PUBLICADO
  MANUTENCAO
}

enum ProjectCategory {
  RESTAURANTE
  OFICINA
  LOJA
  SERVICOS
  OUTROS
}

enum OrgRole {
  OWNER
  MEMBER
}

enum TaskStatus {
  TODO
  DOING
  DONE
}

enum TicketStatus {
  ABERTO
  EM_ANDAMENTO
  AGUARDANDO_CLIENTE
  RESOLVIDO
  FECHADO
}

enum TicketPriority {
  BAIXA
  MEDIA
  ALTA
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
  CANCELED
}

model User {
  id           String      @id @default(cuid())
  name         String?
  email        String      @unique
  passwordHash String?
  role         UserRole    @default(CLIENT)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  organizations Organization[] @relation("OrgOwner")
  memberships   Membership[]
  assignedTasks Task[]         @relation("TaskAssignee")
  tickets       Ticket[]       @relation("TicketCreator")
  messages      TicketMessage[]
  audits        AuditLog[]
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  ownerId   String
  owner     User     @relation("OrgOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects  Project[]
  members   Membership[]
  invoices  Invoice[]
}

model Membership {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  roleInOrg      OrgRole      @default(MEMBER)
  createdAt      DateTime     @default(now())

  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

model Plan {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  priceCents Int
  slaHours  Int
  createdAt DateTime @default(now())

  projects  Project[]
}

model Project {
  id             String          @id @default(cuid())
  organizationId String
  planId         String
  category       ProjectCategory
  status         ProjectStatus   @default(ONBOARDING)

  title          String
  description    String?
  address        String?
  phone          String?
  instagram      String?
  previewUrl     String?
  prodUrl        String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan           Plan         @relation(fields: [planId], references: [id])

  intake         Intake?
  assets         Asset[]
  tasks          Task[]
  tickets        Ticket[]
}

model Intake {
  id          String   @id @default(cuid())
  projectId   String   @unique
  dataJson    Json
  submittedAt DateTime?
  isDraft     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Asset {
  id        String   @id @default(cuid())
  projectId String
  type      String
  filename  String
  path      String
  createdAt DateTime @default(now())

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Task {
  id         String     @id @default(cuid())
  projectId  String
  title      String
  status     TaskStatus @default(TODO)
  assigneeId String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee   User?      @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
}

model Ticket {
  id          String        @id @default(cuid())
  projectId   String
  createdById String
  status      TicketStatus  @default(ABERTO)
  priority    TicketPriority @default(MEDIA)
  subject     String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy   User          @relation("TicketCreator", fields: [createdById], references: [id], onDelete: Cascade)
  messages    TicketMessage[]
}

model TicketMessage {
  id        String   @id @default(cuid())
  ticketId  String
  authorId  String
  message   String
  createdAt DateTime @default(now())

  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model Invoice {
  id             String        @id @default(cuid())
  organizationId String
  amountCents    Int
  status         InvoiceStatus @default(PENDING)
  provider       String        @default("MOCK")
  reference      String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String?
  entityId   String?
  metaJson   Json?
  createdAt  DateTime @default(now())

  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
}
